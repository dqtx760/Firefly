---
import Footer from "@components/Footer.astro";
import Navbar from "@components/Navbar.astro";
import BackToTop from "@components/control/BackToTop.astro";
import SideBar from "@components/widget/SideBar.astro";
import type { MarkdownHeading } from "astro";
import { Icon } from "astro-icon/components";
import ImageWrapper from "../components/misc/ImageWrapper.astro";
import TOC from "../components/widget/TOC.astro";
import Announcement from "../components/widget/Announcement.astro";
import { siteConfig } from "../config";
import {
	BANNER_HEIGHT,
	BANNER_HEIGHT_EXTEND,
	MAIN_PANEL_OVERLAPS_BANNER_HEIGHT,
} from "../constants/constants";
import Layout from "./Layout.astro";

interface Props {
	title?: string;
	banner?: string;
	description?: string;
	lang?: string;
	setOGTypeArticle?: boolean;
	headings?: MarkdownHeading[];
}

const {
	title,
	banner,
	description,
	lang,
	setOGTypeArticle,
	headings = [],
} = Astro.props;
const hasBannerCredit =
	siteConfig.banner.enable && siteConfig.banner.credit.enable;
const hasBannerLink = !!siteConfig.banner.credit.url;

const mainPanelTop = siteConfig.banner.enable
	? `calc(${BANNER_HEIGHT}vh - ${MAIN_PANEL_OVERLAPS_BANNER_HEIGHT}rem)`
	: "5.5rem";
---

<Layout title={title} banner={banner} description={description} lang={lang} setOGTypeArticle={setOGTypeArticle}>

<!-- Navbar -->
<slot slot="head" name="head"></slot>
<div id="top-row" class="z-50 pointer-events-none relative transition-all duration-700 max-w-[var(--page-width)] px-4 md:px-4 mx-auto" class:list={[""]}>
    <div id="navbar-wrapper" class="pointer-events-auto sticky top-0 transition-all">
        <Navbar></Navbar>
    </div>
</div>

<!-- Banner -->
{siteConfig.banner.enable && <div id="banner-wrapper" class=`absolute z-10 w-full transition duration-700 overflow-hidden` style=`top: -${BANNER_HEIGHT_EXTEND}vh`>
    <ImageWrapper id="banner" alt="Banner image of the blog" class:list={["object-cover h-full transition duration-700 opacity-0 scale-105"]}
                  src={siteConfig.banner.src} position={siteConfig.banner.position}
    >
    </ImageWrapper>
</div>}

<!-- Main content -->
<div class="absolute w-full z-30 pointer-events-none" style=`top: ${mainPanelTop}`>
    <!-- The pointer-events-none here prevent blocking the click event of the TOC -->
    <div class="relative max-w-[var(--page-width)] mx-auto pointer-events-auto">
        <div id="main-grid" class="transition duration-700 w-full left-0 right-0 grid grid-cols-[17.5rem_auto] grid-rows-[auto_auto_auto] lg:grid-rows-[auto_1fr]
    mx-auto gap-4 px-4 md:px-4"
        >
            <!-- Banner image credit -->
            {hasBannerCredit && <a href={siteConfig.banner.credit.url} id="banner-credit" target="_blank" rel="noopener" aria-label="Visit image source"
                                   class:list={["group onload-animation transition-all absolute flex justify-center items-center rounded-full " +
                                   "px-3 right-4 -top-[3.25rem] bg-black/60 hover:bg-black/70 h-9", {"hover:pr-9 active:bg-black/80": hasBannerLink}]}
            >
                <Icon class="text-white/75 text-[1.25rem] mr-1" name="material-symbols:copyright-outline-rounded" ></Icon>
                <div class="text-white/75 text-xs">{siteConfig.banner.credit.text}</div>
                <Icon class:list={["transition absolute text-[oklch(0.75_0.14_var(--hue))] right-4 text-[0.75rem] opacity-0",
                    {"group-hover:opacity-100": hasBannerLink}]}
                      name="fa6-solid:arrow-up-right-from-square">
                </Icon>
            </a>}


            <SideBar class="mb-4 row-start-2 col-span-2 lg:row-start-1 lg:col-span-1 lg:max-w-[17.5rem] onload-animation" headings={headings}></SideBar>

            <main id="swup-container" class="transition-swup-fade row-start-1 col-span-2 lg:row-start-1 lg:col-span-1 overflow-visible min-w-0">
                <div id="content-wrapper" class="onload-animation">
                    <!-- the overflow-hidden here prevent long text break the layout-->
                    <!-- make id different from windows.swup global property -->
                    <Announcement></Announcement>
                    <slot></slot>
                </div>
            </main>

            <div class="footer col-span-2 row-start-3 lg:col-span-1 lg:col-start-2 lg:row-start-2 onload-animation">
                <Footer></Footer>
            </div>
        </div>

        <BackToTop></BackToTop>
    </div>
</div>

<!-- The things that should be under the banner, only the TOC for now -->
<div class="absolute w-full z-0 hidden 2xl:block">
    <div class="relative max-w-[var(--page-width)] mx-auto">
        <!-- TOC component -->
        {siteConfig.toc.enable && <div id="toc-wrapper" class:list={["hidden lg:block transition absolute top-0 -right-[var(--toc-width)] w-[var(--toc-width)] flex items-center",
            {"toc-hide": siteConfig.banner.enable}]}
        >
            <div id="toc-inner-wrapper" class="fixed top-14 w-[var(--toc-width)] h-[calc(100vh_-_20rem)] overflow-y-scroll overflow-x-hidden hide-scrollbar">
                <div id="toc" class="w-full h-full transition-swup-fade ">
                    <div class="h-8 w-full"></div>
                    <TOC headings={headings}></TOC>
                    <div class="h-8 w-full"></div>
                </div>
            </div>
        </div>}

        <!-- #toc needs to exist for Swup to work normally -->
        {!siteConfig.toc.enable && <div id="toc"></div>}
    </div>
</div>

<!-- 霓虹灯风格微信二维码弹窗 -->
<style define:vars={{}}>
    @property --neon-angle { syntax: '<angle>'; inherits: false; initial-value: 0deg; }

    .neon-modal-backdrop {
        background: radial-gradient(900px 500px at 50% 25%, rgba(255, 105, 198, 0.15), rgba(0, 0, 0, 0) 65%),
                    radial-gradient(900px 500px at 35% 70%, rgba(181, 107, 255, 0.15), rgba(0, 0, 0, 0) 65%),
                    radial-gradient(900px 500px at 70% 75%, rgba(77, 199, 255, 0.15), rgba(0, 0, 0, 0) 65%),
                    rgba(0, 0, 0, 0.75);
        backdrop-filter: blur(16px) saturate(140%);
    }

    .neon-modal-box {
        position: relative;
        border-radius: 28px;
        background: linear-gradient(145deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.05));
        border: 1px solid rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(20px) saturate(150%);
        overflow: hidden;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7),
                    0 0 25px rgba(255, 105, 198, 0.25),
                    0 0 50px rgba(77, 199, 255, 0.15);
    }

    .neon-modal-box::before {
        content: "";
        position: absolute;
        inset: -2px;
        border-radius: inherit;
        padding: 2.5px;
        background: conic-gradient(from var(--neon-angle), #ff69c6, #b56bff, #4dc7ff, #ff69c6);
        -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
        -webkit-mask-composite: xor;
        mask-composite: exclude;
        animation: neonAngle 6s linear infinite;
        pointer-events: none;
        z-index: 10;
    }

    @keyframes neonAngle { to { --neon-angle: 360deg; } }

    .neon-modal-box button:hover {
        background: rgba(255,255,255,0.2) !important;
    }
</style>

<div id="qr-modal" class="hidden neon-modal-backdrop" onclick="closeQRModal()" style="position: fixed; inset: 0; z-index: 99999; display: none; align-items: center; justify-content: center; padding: 1rem;">
    <div class="neon-modal-box" onclick="event.stopPropagation()" style="padding: 2rem; max-width: 28rem; width: 100%; display: flex; flex-direction: column; align-items: center;">
        <h3 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1.5rem; color: #f472b6; text-shadow: 0 0 10px rgba(236, 72, 153, 0.5);">扫码添加微信</h3>
        <div style="position: relative; margin-bottom: 1.5rem; border: 1px solid rgba(255,255,255,0.2); padding: 0.5rem; border-radius: 1rem; background: rgba(0,0,0,0.2); backdrop-filter: blur(4px);">
            <img src="/qq-qrcode.png" alt="WeChat QR Code" style="width: 16rem; height: 16rem; object-fit: contain; border-radius: 0.75rem; display: block;" />
        </div>
        <p style="color: rgba(255,255,255,0.8); font-family: monospace; font-size: 0.875rem;">微信号: <span id="modal-wx-id" style="color: #f472b6; font-weight: bold;">dqtx33</span></p>
        <div style="display: flex; gap: 1rem; width: 100%; margin-top: 1.5rem;">
            <button onclick="copyModalWx(event)" class="wx-copy-btn" style="flex: 1; padding: 0.75rem; border-radius: 0.75rem; font-weight: 600; font-size: 0.875rem; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); cursor: pointer; transition: all 0.2s;">复制微信号</button>
            <button onclick="closeQRModal()" style="flex: 1; padding: 0.75rem; border-radius: 0.75rem; font-weight: 600; font-size: 0.875rem; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); cursor: pointer; transition: all 0.2s;">关闭</button>
        </div>
    </div>
</div>

<script is:inline>
    // 打开二维码弹窗
    function openQRModal() {
        const modal = document.getElementById('qr-modal');
        modal.classList.remove('hidden');
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }

    // 关闭二维码弹窗
    function closeQRModal() {
        const modal = document.getElementById('qr-modal');
        modal.classList.add('hidden');
        modal.style.display = 'none';
        document.body.style.overflow = '';
    }

    // 复制微信号
    function copyModalWx(e) {
        if (e) e.stopPropagation();
        const wxId = document.getElementById('modal-wx-id').innerText;
        const textArea = document.createElement("textarea");
        textArea.value = wxId;
        textArea.style.position = "fixed";
        textArea.style.left = "-9999px";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            const successful = document.execCommand('copy');
            if (successful) {
                const btn = e.target;
                const oldText = btn.innerText;
                btn.innerText = '已复制！';
                btn.style.color = "#4ade80";
                setTimeout(() => {
                    btn.innerText = oldText;
                    btn.style.color = "";
                }, 2000);
            }
        } catch (err) {
            console.error('复制失败', err);
        }
        document.body.removeChild(textArea);
    }

    // ESC 键关闭弹窗
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closeQRModal();
        }
    });
</script>
</Layout>
