---
/**
 * 视频装饰组件
 * 显示循环播放的视频，带错误处理和重试机制
 */
interface Props {
    src?: string;
}

const { src = "https://storage.googleapis.com/creatorspace-public/users%2Fcm69rcp2205nuql01acfbyq0v%2Fokcia7dTfbFQHS73-users-cld4n5p4q1ahnpo0y6kwwv333-rJ1JJZyb4PQAnAlc-waterfall_test.mp4" } = Astro.props;

// 解码URL（处理已编码的URL）
const decodedSrc = decodeURI(src);
---

<div class="video-decoration">
    <video
        autoplay
        loop
        muted
        playsinline
        data-video-src={decodedSrc}
        class="video-decoration-video"
    >
        <source src={decodedSrc} type="video/mp4">
    </video>
</div>

<script>
    function initVideos() {
        document.querySelectorAll('.video-decoration-video').forEach(video => {
            // 重置视频状态
            video.classList.remove('loading', 'loaded', 'error');

            // 强制重新加载视频
            video.load();

            // 添加加载事件监听
            video.addEventListener('loadstart', () => {
                video.classList.add('loading');
            }, { once: true });

            video.addEventListener('canplay', () => {
                video.classList.remove('loading');
                video.classList.add('loaded');
                video.play().catch(() => {});
            }, { once: true });

            video.addEventListener('error', () => {
                video.classList.add('error');
                // 2秒后重试
                setTimeout(() => {
                    const currentSrc = video.src;
                    video.src = '';
                    video.src = currentSrc;
                    video.load();
                }, 2000);
            }, { once: true });

            // 如果视频已加载，直接标记为已加载
            if (video.readyState >= 2) {
                video.classList.add('loaded');
            }
        });
    }

    const setup = () => {
        // 初始化视频
        initVideos();

        // 使用 Swup hooks 监听页面切换
        window.swup.hooks.on('content:replace', initVideos);
        window.swup.hooks.on('page:view', initVideos);
    };

    if (window.swup) {
        setup();
    } else {
        document.addEventListener('swup:enable', setup);
    }
</script>

<style>
    .video-decoration {
        width: 100%;
        height: 160px;
        overflow: hidden;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        background: linear-gradient(135deg, var(--primary) / 10%, var(--primary) / 5%);
        position: relative;
    }

    .video-decoration video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .video-decoration video.loading {
        opacity: 0.5;
    }

    .video-decoration video.error {
        opacity: 0.3;
        filter: grayscale(50%);
    }

    /* 加载指示器 */
    .video-decoration::after {
        content: '加载中...';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 12px;
        color: var(--primary);
        opacity: 0;
        transition: opacity 0.3s;
    }

    .video-decoration:has(.loading)::after {
        opacity: 1;
    }

    .video-decoration:has(.loaded)::after,
    .video-decoration:has(.error)::after {
        opacity: 0;
    }
</style>
