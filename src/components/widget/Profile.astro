---
import { Icon } from "astro-icon/components";
import { profileConfig, siteConfig, umamiConfig } from "../../config";
import { getSortedPosts } from "@utils/content-utils";

const config = profileConfig;
const posts = await getSortedPosts();
const totalPosts = posts.length;
let totalWords = 0;
for (const post of posts) {
    const { remarkPluginFrontmatter } = await post.render();
    if (remarkPluginFrontmatter && remarkPluginFrontmatter.words) {
        totalWords += remarkPluginFrontmatter.words;
    }
}

---
<div class="card-base p-3 border border-black/10 dark:border-white/10">
    <div class="relative mx-auto mt-1 mb-3 w-28 h-28 rounded-full overflow-hidden" style={`--theme-hue: ${siteConfig.themeColor.hue}`}>
        <img src={config.avatar} alt="Profile Image of the Author" class="w-full h-full object-cover transition duration-500" />
    </div>
    <div class="px-2 text-center">
        <div class="font-bold text-xl mb-1 profile-name-gradient transition">{config.name}</div>
        <div class="h-1 w-5 bg-[var(--primary)] mx-auto rounded-full mb-2 transition"></div>
        <div class="text-center mb-2.5 transition text-black dark:text-neutral-400">{config.bio}</div>
        <div class="flex flex-wrap gap-2 justify-center mb-1">
            <!-- 微信图标 - 点击弹窗 -->
            <button aria-label="微信" onclick="openQRModal()" class="btn-regular rounded-lg h-10 w-10 active:scale-90">
                <svg class="w-6 h-6 transition fill-current" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M21.502 19.525c1.524-1.105 2.498-2.738 2.498-4.554 0-3.326-3.237-6.023-7.229-6.023s-7.229 2.697-7.229 6.023c0 3.327 3.237 6.024 7.229 6.024.825 0 1.621-.117 2.36-.33l.212-.032c.139 0 .265.043.384.111l1.583.914.139.045c.133 0 .241-.108.241-.241l-.039-.176-.326-1.215-.025-.154c0-.162.08-.305.202-.392zm-12.827-17.228c-4.791 0-8.675 3.236-8.675 7.229 0 2.178 1.168 4.139 2.997 5.464.147.104.243.276.243.471l-.03.184-.391 1.458-.047.211c0 .16.13.29.289.29l.168-.054 1.899-1.097c.142-.082.293-.133.46-.133l.255.038c.886.255 1.842.397 2.832.397l.476-.012c-.188-.564-.291-1.158-.291-1.771 0-3.641 3.542-6.593 7.911-6.593l.471.012c-.653-3.453-4.24-6.094-8.567-6.094zm5.686 11.711c-.532 0-.963-.432-.963-.964 0-.533.431-.964.963-.964.533 0 .964.431.964.964 0 .532-.431.964-.964.964zm4.82 0c-.533 0-.964-.432-.964-.964 0-.533.431-.964.964-.964.532 0 .963.431.963.964 0 .532-.431.964-.963.964zm-13.398-5.639c-.639 0-1.156-.518-1.156-1.156 0-.639.517-1.157 1.156-1.157.639 0 1.157.518 1.157 1.157 0 .638-.518 1.156-1.157 1.156zm5.783 0c-.639 0-1.156-.518-1.156-1.156 0-.639.517-1.157 1.156-1.157.639 0 1.157.518 1.157 1.157 0 .638-.518 1.156-1.157 1.156z"/>
                </svg>
            </button>

            <!-- 其他社交链接 -->
            {config.links.slice(1).map((item) => (
                <a rel="me" aria-label={item.name} href={item.url} target="_blank" class="btn-regular rounded-lg h-10 w-10 active:scale-90">
                    <Icon name={item.icon} class="text-[1.5rem]"></Icon>
                </a>
            ))}
        </div>

        <!-- 全站文章与字数统计 -->
        <div class="grid grid-cols-2 mt-3 pt-3 border-t border-neutral-300 dark:border-neutral-700">
            <div class="text-center">
                <div class="text-xs mb-1 flex items-center justify-center gap-1">
                    <Icon name="material-symbols:article-outline" class="text-base"></Icon>
                    <span class="text-xs">文章数</span>
                </div>
                <div class="font-bold text-lg text-neutral-700 dark:text-neutral-300">{totalPosts}</div>
            </div>
            <div class="text-center border-l border-neutral-300 dark:border-neutral-700">
                <div class="text-xs mb-1 flex items-center justify-center gap-1">
                    <Icon name="material-symbols:format-list-numbered" class="text-base"></Icon>
                    <span class="text-xs">总字数</span>
                </div>
                <div class="font-bold text-lg text-neutral-700 dark:text-neutral-300">
                    {(totalWords / 10000).toFixed(1)}w
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .loading-bar {
        transition: opacity 0.5s ease-out;
    }

    /* 二维码弹窗动画 */
    @keyframes scale-in {
        from {
            opacity: 0;
            transform: scale(0.9);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    .animate-scale-in {
        animation: scale-in 0.2s ease-out;
    }
</style>

<style is:global>
    /* 标题渐变样式 - 全局样式 */
    .profile-name-gradient {
        background: linear-gradient(135deg, #0ea5e9, #8b5cf6) !important;
        -webkit-background-clip: text !important;
        -webkit-text-fill-color: transparent !important;
        background-clip: text !important;
        color: transparent !important;
    }

    /* 暗黑模式适配 */
    html.dark .profile-name-gradient {
        background: linear-gradient(135deg, #38bdf8, #a78bfa) !important;
        -webkit-background-clip: text !important;
        -webkit-text-fill-color: transparent !important;
        background-clip: text !important;
    }
</style>

<script is:inline>
    // 打开二维码弹窗
    function openQRModal() {
        const modal = document.getElementById('qr-modal');
        modal.classList.remove('hidden');
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }

    // 关闭二维码弹窗
    function closeQRModal() {
        const modal = document.getElementById('qr-modal');
        modal.classList.add('hidden');
        modal.style.display = 'none';
        document.body.style.overflow = '';
    }

    // 打开赞助弹窗
    function openSponsorModal() {
        const modal = document.getElementById('sponsor-modal');
        modal.classList.remove('hidden');
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }

    // 关闭赞助弹窗
    function closeSponsorModal() {
        const modal = document.getElementById('sponsor-modal');
        modal.classList.add('hidden');
        modal.style.display = 'none';
        document.body.style.overflow = '';
    }

    // 切换支付方式
    function switchPayment(type) {
        const qrImg = document.getElementById('sponsor-qr-img');
        const wechatTab = document.getElementById('wechat-pay-tab');
        const alipayTab = document.getElementById('alipay-tab');

        if (type === 'wechat') {
            qrImg.src = '/sponsors/wechat.png';
            wechatTab.style.background = 'rgba(255,255,255,0.15)';
            wechatTab.style.color = 'white';
            alipayTab.style.background = 'transparent';
            alipayTab.style.color = 'rgba(255,255,255,0.6)';
        } else {
            qrImg.src = '/sponsors/alipay.png';
            alipayTab.style.background = 'rgba(255,255,255,0.15)';
            alipayTab.style.color = 'white';
            wechatTab.style.background = 'transparent';
            wechatTab.style.color = 'rgba(255,255,255,0.6)';
        }
    }

    // 复制微信号
    function copyModalWx(e) {
        if (e) e.stopPropagation();
        const wxId = document.getElementById('modal-wx-id').innerText;
        const textArea = document.createElement("textarea");
        textArea.value = wxId;
        textArea.style.position = "fixed";
        textArea.style.left = "-9999px";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            const successful = document.execCommand('copy');
            if (successful) {
                const btn = e.target;
                const oldText = btn.innerText;
                btn.innerText = '已复制！';
                btn.style.color = "#4ade80";
                setTimeout(() => {
                    btn.innerText = oldText;
                    btn.style.color = "";
                }, 2000);
            }
        } catch (err) {
            console.error('复制失败', err);
        }
        document.body.removeChild(textArea);
    }

    // ESC 键关闭弹窗
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closeQRModal();
            closeSponsorModal();
        }
    });
</script>
