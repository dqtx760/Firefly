import{D as j}from"./base.CrPFMexR.js";class z extends j{constructor(){super(...arguments),this.tokenize=H}equals(m,o,u){return u.ignoreWhitespace?((!u.newlineIsToken||!m.includes(`
`))&&(m=m.trim()),(!u.newlineIsToken||!o.includes(`
`))&&(o=o.trim())):u.ignoreNewlineAtEof&&!u.newlineIsToken&&(m.endsWith(`
`)&&(m=m.slice(0,-1)),o.endsWith(`
`)&&(o=o.slice(0,-1))),super.equals(m,o,u)}}const F=new z;function R(v,m,o){return F.diff(v,m,o)}function H(v,m){m.stripTrailingCr&&(v=v.replace(/\r\n/g,`
`));const o=[],u=v.split(/(\n|\r\n)/);u[u.length-1]||u.pop();for(let S=0;S<u.length;S++){const A=u[S];S%2&&!m.newlineIsToken?o[o.length-1]+=A:o.push(A)}return o}(async function(){const v="fuwari-rss-store",o="posts",u="blog-posts-cache",S="new-post-list",_="/".replace(/^\/+|\/+$/g,"")||"root";function $(){return new Promise((n,f)=>{const t=indexedDB.open(v,3);t.onerror=()=>f(t.error),t.onsuccess=()=>n(t.result),t.onupgradeneeded=a=>{const i=a.target.result;if(i.objectStoreNames.contains(o)){a.target.transaction.objectStore(o).keyPath!=="id"&&(i.deleteObjectStore(o),i.createObjectStore(o,{keyPath:"id"}));return}i.createObjectStore(o,{keyPath:"id"})}})}function O(n,f){const t=(n||f||"").trim();if(!t)return"";try{const a=new URL(t,window.location.origin);return`${a.pathname}${a.search}${a.hash}`}catch{return t}}function C(n){return`${_}:${n}`}function q(n){return new Promise((f,t)=>{const e=n.transaction([o],"readonly").objectStore(o).getAll();e.onsuccess=()=>f(e.result),e.onerror=()=>t(e.error)})}function N(n,f){return new Promise((t,a)=>{const i=n.transaction([o],"readwrite"),e=i.objectStore(o);f.forEach(g=>{const r={...g,id:C(g.guid)};e.put(r)}),i.oncomplete=()=>t(),i.onerror=()=>a(i.error)})}async function M(){try{const f=await(await fetch("/rss.xml",{cache:"no-store"})).text(),a=new DOMParser().parseFromString(f,"text/xml");return Array.from(a.querySelectorAll("item")).map(e=>{const g=e.querySelector("title")?.textContent||"",r=(e.querySelector("link")?.textContent||"").trim(),d=(e.querySelector("guid")?.textContent||"").trim(),k=O(d||r,r),I=new Date(e.querySelector("pubDate")?.textContent||"").getTime(),p=e.querySelector("description")?.textContent||"",c=e.getElementsByTagNameNS("http://purl.org/rss/1.0/modules/content/","encoded")[0]?.textContent||e.getElementsByTagName("content:encoded")[0]?.textContent||e.querySelector("content")?.textContent||"";return{title:g,link:r,guid:k,pubDate:I,description:p,content:c}})}catch(n){return console.error("Failed to fetch RSS:",n),[]}}function B(n,f){if(!n||!f)return null;const t=r=>{const d=document.createElement("DIV");return d.innerHTML=r,d.textContent||d.innerText||""},a=t(n),i=t(f),e=R(a,i);return e.some(r=>r.added||r.removed)?e:null}function U(n){return n&&n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function h(n,f,t,a){const i=document.getElementById("notification-minimized"),e=document.getElementById("notification-panel"),g=document.getElementById(S),r=document.getElementById("notification-dot"),d=document.getElementById("minimize-notification"),k=document.getElementById("clear-notification"),I="fuwari-notification-state",p="fuwari-notification-init-time";if(!i||!e||!g)return;requestAnimationFrame(()=>{i.classList.remove("translate-y-20","opacity-0")});const s=new Date(a).toLocaleString(),c=new Date(f).toLocaleString();if(n.length===0){g.innerHTML=`<div class="text-center text-gray-500 dark:text-gray-400 py-4">
                <p class="text-sm font-medium mb-2">暂无文章更新</p>
                <div class="text-xs opacity-70 bg-gray-100 dark:bg-gray-800 rounded px-2 py-1 inline-block">
                    ${s} - ${c}
                </div>
             </div>`,r?.classList.add("hidden"),T();return}let x=`
            <div class="text-xs text-gray-500 dark:text-gray-400 mb-2 px-1 flex flex-col gap-0.5">
                <div class="font-medium">发现更新</div>
                <div class="opacity-70 text-[10px]">${s} - ${c}</div>
            </div>`;n.forEach(l=>{const w=l.isUpdated,b=w?'<span class="text-xs bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300 px-1.5 py-0.5 rounded ml-2">更新</span>':'<span class="text-xs bg-green-100 dark:bg-green-900 text-green-600 dark:text-green-300 px-1.5 py-0.5 rounded ml-2">新文章</span>';let y="";const P="diff-"+l.guid.replace(/[^a-zA-Z0-9-_]/g,"_");w&&l.diff&&(y=`
                <button onclick="window.toggleDiff('${P}')" class="ml-auto text-xs text-[var(--primary)] hover:underline focus:outline-none pointer-events-auto">
                    查看变更
                </button>`),x+=`
            <div class="mb-2 last:mb-0">
                <div class="flex items-center justify-between p-2 rounded-lg hover:bg-[var(--primary)]/5 transition-colors">
                    <a href="${l.link}" class="font-medium truncate pr-2 hover:text-[var(--primary)] transition-colors text-black dark:text-white block flex-1" target="_blank">
                        ${l.title}
                    </a>
                    <div class="flex items-center shrink-0">
                        ${y}
                        ${b}
                    </div>
                </div>
                ${w&&l.diff?`
                <div id="${P}" class="hidden mt-2 p-2 bg-gray-50 dark:bg-gray-800 rounded text-xs overflow-x-auto border border-gray-200 dark:border-gray-700 max-h-60 overflow-y-auto">
                    ${l.diff.map(D=>`<div class="${D.added?"bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 block my-1 p-1 rounded break-all whitespace-pre-wrap":D.removed?"bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 block my-1 p-1 rounded break-all whitespace-pre-wrap":"text-gray-500 dark:text-gray-400 block my-1 p-1 break-all whitespace-pre-wrap"}">${U(D.value)}</div>`).join("")}
                </div>
                `:""}
            </div>`}),g.innerHTML=x,t?(r?.classList.remove("hidden"),setTimeout(()=>{E()},1500)):r?.classList.add("hidden"),T();function T(){const l=()=>{e.classList.remove("hidden"),requestAnimationFrame(()=>{e.classList.remove("translate-y-4","opacity-0","scale-95")}),r?.classList.add("hidden")},w=()=>{e.classList.add("translate-y-4","opacity-0","scale-95"),setTimeout(()=>{e.classList.add("hidden")},300)};i.onclick=()=>{e.classList.contains("hidden")?l():w()},d.onclick=b=>{b.stopPropagation(),w(),setTimeout(()=>{i.classList.add("translate-y-20","opacity-0"),i.classList.add("pointer-events-none")},300)},k&&(k.onclick=b=>{b.stopPropagation(),localStorage.removeItem(I);const y=Date.now();localStorage.setItem(p,y.toString()),h([],y,!1,y)}),g.hasAttribute("data-listening")||(g.addEventListener("click",b=>{const y=b.target.closest("[data-diff-toggle]");if(y){const P=y.getAttribute("data-diff-toggle"),D=document.getElementById(P);D&&D.classList.toggle("hidden")}}),g.setAttribute("data-listening","true"))}function E(){e.classList.remove("hidden"),requestAnimationFrame(()=>{e.classList.remove("translate-y-4","opacity-0","scale-95")}),r?.classList.add("hidden")}const L=()=>{e.classList.add("translate-y-4","opacity-0","scale-95"),setTimeout(()=>{e.classList.add("hidden")},300)};i.onclick=()=>{e.classList.contains("hidden")?E():L()},d.onclick=l=>{l.stopPropagation(),L()},window.toggleDiff=function(l){const w=document.getElementById(l);w&&w.classList.toggle("hidden")}}try{if(new URLSearchParams(window.location.search).has("debug-notification")){console.log("[Notification] Developer mode active"),h([{title:"Test New Post 1",link:"#",guid:"test-1",isUpdated:!1},{title:"Test Updated Post",link:"#",guid:"test-2",isUpdated:!0,diff:[{value:`This is some unchanged text context.
`,added:void 0,removed:void 0},{value:`This line was removed.
`,added:void 0,removed:!0},{value:`This line is new.
`,added:!0,removed:void 0},{value:`More unchanged text.
`,added:void 0,removed:void 0}]}],Date.now(),!0,Date.now());return}const t=await M();if(t.length===0)return;const a=await $(),i=await q(a),e="fuwari-notification-state",g="fuwari-notification-init-time";let r=localStorage.getItem(g);r||(r=Date.now().toString(),localStorage.setItem(g,r));const d=parseInt(r),k=localStorage.getItem(u);if(i.length===0&&k){console.log("[Notification] Migrating from localStorage..."),await N(a,t),localStorage.removeItem(u),h([],Date.now(),!1,d);return}if(i.length===0)await N(a,t),localStorage.removeItem(e),h([],Date.now(),!1,d);else{const I=new Map(i.map(s=>[s.id||C(s.guid||s.link||s.title),s])),p=[];if(t.forEach(s=>{const c=I.get(C(s.guid));if(!c)p.push({...s,isUpdated:!1});else{const x=s.title!==c.title,T=s.pubDate!==c.pubDate,E=s.description!==c.description,L=s.content!==c.content;if(x||T||E||L){let l=null;L?l=B(c.content,s.content):E?l=B(c.description,s.description):x&&(l=B(c.title,s.title)),p.push({...s,isUpdated:!0,diff:l})}}}),p.length>0){if(p.length===t.length&&p.every(T=>!T.isUpdated)){console.log('[Notification] Intercepted "all new" posts scenario. Suppressing notification.'),await N(a,t),localStorage.removeItem(e),h([],Date.now(),!1,d);return}const c=Date.now(),x={timestamp:c,items:p};localStorage.setItem(e,JSON.stringify(x)),await N(a,t),h(p,c,!0,d)}else{const s=localStorage.getItem(e);if(s)try{const c=JSON.parse(s);h(c.items,c.timestamp,!1,d)}catch(c){console.error("Failed to parse notification state",c),h([],Date.now(),!1,d)}else h([],Date.now(),!1,d)}}}catch(n){console.error("New post check failed:",n)}})();
